@using System;
@using System.Web;
@using System.IO;

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    string tableTextColor;
    if (HttpContextAccessor.HttpContext.Request.Cookies["theme"] == "dark") tableTextColor = "white";
    else tableTextColor = "dark";
    ViewData["Title"] = "My Page";
    if (ViewData["admin mode"].ToString() != "available" && ViewData["admin mode"].ToString() != "not available")
    {
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
        @ViewData["admin mode"]
        <div class="row">
            <div class="col-md-2">
                <form asp-controller="MyPage" asp-action="BackToAdminMode" class="form-horizontal">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-left-square"></i> @TextModel.Context["back to admin mode"]</button>
                </form>
            </div>
        </div>
        <p></p>
    }
}

<script>
    function getUserRate(rate, id) {
        let rateNumber = parseFloat(rate);
        let i;
        let starRate = '';
        for (i = 0; i < 5; i++) {
            if (rateNumber >= i + 1) {
                starRate += '<i class="bi bi-star-fill"></i>';
            }
            else if (rateNumber + 0.5 >= i + 1) {
                starRate += '<i class="bi bi-star-half"></i>';
            }
            else {
                starRate += '<i class="bi bi-star"></i>';
            }
        }
        document.getElementById(id).insertAdjacentHTML("beforeend", starRate);
    }
</script>

<div class="text-center">
    @{
        int userLikes = (await ViewData.Model.FindUserByNameAsync(ViewData["username"].ToString())).Likes;
    }
    <div style="float: right">@TextModel.Context["your likes"] @userLikes</div>
    <h1 class="display-4">@TextModel.Context["my page"]</h1>
</div>
<div class="row">
    <div class="col-md-2">
        <form asp-controller="MyPage" asp-action="NewReview" class="form-horizontal">
            <button type="submit" class="btn btn-primary">@TextModel.Context["new review"]</button>
        </form>
        <p></p>
    </div>
    @{
        if (ViewData["admin mode"].ToString() == "available")
        {
            <div class="col-md-3">
                <form asp-controller="MyPage" asp-action="AdminMode" class="form-horizontal">
                    <button type="submit" class="btn btn-primary">@TextModel.Context["admin mode"]</button>
                </form>
            </div>
        }
    }
</div>
<h3 style="margin-top: 4%">@TextModel.Context["my reviews"]</h3>
<form asp-controller="MyPage" asp-action="ChangeParameters" class="form-horizontal">
    <div class="form-floating">
        <p></p>
        @TextModel.Context["filter"]
        <select name="categoryFromView" id="categorySelector" onchange="form.submit();">
            <option value="all">@TextModel.Context["all"]</option>
            <option value="no category">@TextModel.Context["no category"]</option>
            <option value="films">@TextModel.Context["films"]</option>
            <option value="games">@TextModel.Context["games"]</option>
            <option value="books">@TextModel.Context["books"]</option>
        </select>
        @TextModel.Context["sort order"]
        <select name="sortOrderFromView" id="sortOrderSelector" onchange="form.submit();">
            <option value="no sort">@TextModel.Context["no sort"]</option>
            <option value="date">@TextModel.Context["sort by date"]</option>
            <option value="popular">@TextModel.Context["sort by popularity"]</option>
        </select>
    </div>
    <p></p>
    <script>
        document.getElementById('categorySelector').value = "@ViewData["category"].ToString()";
        document.getElementById('sortOrderSelector').value = "@ViewData["sortOrder"].ToString()";
    </script>
</form>
<table class="table" style="border-style: solid; border-color: red; color: @tableTextColor">
    @foreach (var data in await ViewData.Model.SelectUserReviews(ViewData["username"].ToString(), ViewData["category"].ToString(), ViewData["sortOrder"].ToString()))
    {
        <tr>
            <td>
                <form asp-controller="Review" asp-action="EditReview" class="form-horizontal">
                    <button type="submit" class="btn btn-primary" name="review" value="@data.Id"><i class="bi bi-pen"></i> @TextModel.Context["edit"]</button>
                </form>
                <p></p>
                <form asp-controller="Review" asp-action="ReviewPage" class="form-horizontal">
                    <p><button type="submit" class="btn btn-primary" name="review" value="@data.Id"><i class="bi bi-eyeglasses"></i> @TextModel.Context["watch"]</button></p>
                </form>
                <p></p>
                <form asp-controller="Review" asp-action="RemoveReview" class="form-horizontal">
                    <p><button type="submit" class="btn btn-danger" name="reviewId" value="@data.Id"><i class="bi bi-trash"></i> @TextModel.Context["remove"]</button></p>
                </form>
            </td>
            <td id="@data.Id" align="left" style="width: 80%">
                @{
                    <div class="wrapper" style="width: 30%; float: right;" id="likes-@data.Id">
                        <div style="float: right;">
                            <p>@TextModel.Context["likes"]@data.Likes</p>
                        </div>
                    </div>
                    if (data.ImageUrl != "")
                    {
                        string imgName = data.ImageUrl;
                        byte[] imgBytes = await ImageService.Download(imgName);
                        string str = Convert.ToBase64String(imgBytes);
                        <script>
                            document.getElementById('likes-@data.Id').insertAdjacentHTML("beforeend", '<p><img style="width: 100%" src="data:image/*;base64,@str" alt="Red dot" /></p>');
                        </script>
                    }
                    <p>@TextModel.Context["reviewname"]@data.Name</p>
                    <p>@TextModel.Context["creation review name"]@data.CreationName</p>
                    User user = await ViewData.Model.GetUserByIdAsync(data.AuthorId.ToString());
                    <p>@TextModel.Context["author"]@user.UserName (<i style="color: green">@user.Likes</i>)</p>
                    <p>@TextModel.Context["category"]@TextModel.Context[data.Category]</p>
                    <p>
                        @TextModel.Context["tag"] @foreach (var tag in ViewData.Model.SelectReviewTags(data.Id))
                        {
                            <label>@tag </label>
                        }
                    </p>
                    <p>@TextModel.Context["author rate"]@data.AuthorRate</p>
                    <p>@TextModel.Context["users rate"]<label style="color: yellow" id="userRate-@data.Id"></label></p>
                    <script>
                        getUserRate('@data.UsersRate.ToString().Replace(',', '.')', 'userRate-@data.Id');
                    </script>
                    <p>@TextModel.Context["date"]@data.Date.ToShortDateString()</p>
                    <p>@TextModel.Context["description"]</p>
                }
            </td>
        </tr>
        <script>
            var str = "@HttpUtility.UrlEncode(data.Description.Replace(" ", "\u00A0"))";
            str = decodeURI(str);
            str = str.replaceAll("%2f", "/");
            str = str.replaceAll("%26nbsp%3b", " ");
            document.getElementById('@data.Id').insertAdjacentHTML("beforeend", str);
        </script>
    }
</table>